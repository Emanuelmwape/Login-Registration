<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modern Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.min.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-100 to-white min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <header class="mb-8 text-center">
      <h1 class="text-4xl font-extrabold text-indigo-700">üìä Interaction Analytics</h1>
      <p class="text-sm text-gray-500 mt-1">Track and export user interaction data</p>
    </header>

    <div id="toast" class="hidden fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm"></div>

    <section class="grid lg:grid-cols-3 gap-6 mb-10">
      <div class="bg-white rounded-2xl p-5 shadow-sm border">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è Report Config</h2>
        <div class="flex gap-2">
          <div id="signInArea" class="flex-1 h-32 rounded-lg bg-indigo-50 hover:bg-indigo-100 flex items-center justify-center cursor-pointer transition">
            <span class="text-gray-600">Sign In</span>
          </div>
          <div id="signOutArea" class="flex-1 h-32 rounded-lg bg-indigo-50 hover:bg-indigo-100 flex items-center justify-center cursor-pointer transition">
            <span class="text-gray-600">Sign Out</span>
          </div>
        </div>
        <p class="mt-3 text-sm text-gray-600">Last: <span id="lastClick" class="font-semibold">None</span></p>
        <p class="mt-3 text-sm text-gray-600">Coordinates: <span id="clickCoords" class="font-semibold">None</span></p>
        <p class="mt-3 text-sm text-gray-600">Total Clicks: <span id="totalClicks" class="font-semibold">0</span></p>
        <div class="mt-4 flex gap-3">
          <button onclick="clearData()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-2 text-sm rounded-lg font-medium">üóëÔ∏è Reset</button>
          <button id="undoButton" disabled class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 text-sm rounded-lg font-medium opacity-50 cursor-not-allowed">‚Æ™ Undo</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-5 shadow-sm border lg:col-span-2">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">üìà Weekly Reporting Time</h2>
        <canvas id="dayGraph" height="120"></canvas>
      </div>
    </section>

    <section class="mb-10">
      <div class="bg-white rounded-2xl p-5 shadow-sm border">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">üìÖ Monthly Sign In/Out Records</h2>
        <div class="h-[300px] overflow-y-auto">
          <table class="w-full text-sm text-gray-600 border-collapse">
            <thead>
              <tr class="bg-gray-50 sticky top-0">
                <th class="p-2 text-left border-b">Date</th>
                <th class="p-2 text-left border-b">User</th>
                <th class="p-2 text-left border-b">Sign In</th>
                <th class="p-2 text-left border-b">Sign Out</th>
                <th class="p-2 text-left border-b">Notes/Comments</th>
              </tr>
            </thead>
            <tbody id="monthlyLogTable"></tbody>
          </table>
        </div>
        <div class="mt-4">
          <h3 class="text-sm font-semibold text-gray-800 mb-2">Add Note for Specific Date</h3>
          <div class="flex gap-2 mb-2">
            <select id="noteDateSelect" class="w-1/3 text-sm border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Date</option>
            </select>
            <input id="dateNote" type="text" class="w-2/3 text-sm border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Add note for selected date...">
          </div>
          <button onclick="saveDateNote()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 text-sm rounded-lg font-medium">üíæ Save Date Note</button>
        </div>
        <div class="mt-4 relative">
          <button id="exportButton" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 text-sm rounded-lg font-medium">üì§ Export Records</button>
          <div id="exportMenu" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1">
            <button onclick="exportToExcel()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as Excel</button>
            <button onclick="exportToPDF()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as PDF</button>
            <button onclick="exportToWord()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as Word</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    let clickData = JSON.parse(localStorage.getItem('clickData')) || [];
    let backupData = null;
    let backupNotes = null;

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    function clearData() {
      // Backup clickData and all dateNotes
      backupData = [...clickData];
      backupNotes = {};
      for (let key in localStorage) {
        if (key.startsWith('dateNotes_')) {
          backupNotes[key] = localStorage.getItem(key);
        }
      }
      // Clear data
      localStorage.removeItem('clickData');
      clickData = [];
      document.getElementById('totalClicks').textContent = '0';
      document.getElementById('lastClick').textContent = 'None';
      document.getElementById('clickCoords').textContent = 'None';
      updateMonthlyLogTable();
      // Enable undo button
      document.getElementById('undoButton').disabled = false;
      document.getElementById('undoButton').classList.remove('opacity-50', 'cursor-not-allowed');
      showToast('Data reset. Click Undo to restore');
    }

    function undoReset() {
      if (backupData && backupNotes) {
        // Restore clickData
        clickData = [...backupData];
        localStorage.setItem('clickData', JSON.stringify(clickData));
        // Restore notes
        for (let key in backupNotes) {
          localStorage.setItem(key, backupNotes[key]);
        }
        // Update UI
        document.getElementById('totalClicks').textContent = clickData.length;
        const lastClick = clickData.length > 0 ? clickData[clickData.length - 1] : null;
        document.getElementById('lastClick').textContent = lastClick ? `${lastClick.event} at ${moment(lastClick.timestamp).format('YYYY-MM-DD HH:mm:ss')}` : 'None';
        document.getElementById('clickCoords').textContent = lastClick ? `(${lastClick.x}, ${lastClick.y})` : 'None';
        updateMonthlyLogTable();
        // Clear backup and disable undo button
        backupData = null;
        backupNotes = null;
        document.getElementById('undoButton').disabled = true;
        document.getElementById('undoButton').classList.add('opacity-50', 'cursor-not-allowed');
        showToast('Data has been restored');
      }
    }

    function saveDateNote() {
      const date = document.getElementById('noteDateSelect').value;
      const note = document.getElementById('dateNote').value;
      if (date && note) {
        localStorage.setItem(`dateNotes_${date}`, note);
        updateMonthlyLogTable();
        document.getElementById('dateNote').value = '';
        document.getElementById('noteDateSelect').value = '';
        showToast(`Note saved for ${date}`);
      }
    }

    function editNote(date, note) {
      document.getElementById('noteDateSelect').value = date;
      document.getElementById('dateNote').value = note;
      showToast(`Editing note for ${date}`);
    }

    function deleteNote(date) {
      localStorage.removeItem(`dateNotes_${date}`);
      updateMonthlyLogTable();
      showToast(`Note deleted for ${date}`);
    }

    function updateMonthlyLogTable() {
      const tableBody = document.getElementById('monthlyLogTable');
      const noteDateSelect = document.getElementById('noteDateSelect');
      tableBody.innerHTML = '';
      noteDateSelect.innerHTML = '<option value="">Select Date</option>';
      const currentMonth = moment().format('YYYY-MM');
      const accountData = JSON.parse(localStorage.getItem('accountDetails') || '{}');
      const userName = accountData.fullName || 'Guest';

      const dailyRecords = clickData.reduce((acc, click) => {
        const date = moment(click.timestamp).format('YYYY-MM-DD');
        if (moment(click.timestamp).format('YYYY-MM') === currentMonth) {
          if (!acc[date]) {
            acc[date] = { signIn: null, signOut: null, user: click.user || userName, notes: localStorage.getItem(`dateNotes_${date}`) || '' };
          }
          if (click.event === 'Sign In') {
            if (!acc[date].signIn || click.timestamp < acc[date].signIn) {
              acc[date].signIn = click.timestamp;
            }
          } else if (click.event === 'Sign Out') {
            if (!acc[date].signOut || click.timestamp > acc[date].signOut) {
              acc[date].signOut = click.timestamp;
            }
          }
        }
        return acc;
      }, {});

      Object.keys(dailyRecords).sort().forEach(date => {
        const record = dailyRecords[date];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border-b">${date}</td>
          <td class="p-2 border-b">${record.user}</td>
          <td class="p-2 border-b">${record.signIn ? moment(record.signIn).format('HH:mm:ss') : '-'}</td>
          <td class="p-2 border-b">${record.signOut ? moment(record.signOut).format('HH:mm:ss') : '-'}</td>
          <td class="p-2 border-b">
            ${record.notes ? `
              ${record.notes}
              <button onclick="editNote('${date}', '${record.notes.replace(/'/g, "\\'")}')" class="inline-block bg-green-600 hover:bg-green-700 text-white px-2 py-1 text-xs rounded ml-2">‚úèÔ∏è Edit</button>
              <button onclick="deleteNote('${date}')" class="inline-block bg-rose-500 hover:bg-rose-600 text-white px-2 py-1 text-xs rounded ml-1">üóëÔ∏è Delete</button>
            ` : '-'}
          </td>
        `;
        tableBody.appendChild(row);

        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        noteDateSelect.appendChild(option);
      });

      if (Object.keys(dailyRecords).length === 0) {
        tableBody.innerHTML = '<tr><td class="p-2 border-b" colspan="5">No records for this month</td></tr>';
      }
    }

    function getTableData() {
      const currentMonth = moment().format('YYYY-MM');
      const accountData = JSON.parse(localStorage.getItem('accountDetails') || '{}');
      const userName = accountData.fullName || 'Guest';

      const dailyRecords = clickData.reduce((acc, click) => {
        const date = moment(click.timestamp).format('YYYY-MM-DD');
        if (moment(click.timestamp).format('YYYY-MM') === currentMonth) {
          if (!acc[date]) {
            acc[date] = { signIn: null, signOut: null, user: click.user || userName, notes: localStorage.getItem(`dateNotes_${date}`) || '' };
          }
          if (click.event === 'Sign In') {
            if (!acc[date].signIn || click.timestamp < acc[date].signIn) {
              acc[date].signIn = click.timestamp;
            }
          } else if (click.event === 'Sign Out') {
            if (!acc[date].signOut || click.timestamp > acc[date].signOut) {
              acc[date].signOut = click.timestamp;
            }
          }
        }
        return acc;
      }, {});

      const data = Object.keys(dailyRecords).sort().map(date => ({
        Date: date,
        User: dailyRecords[date].user,
        'Sign In': dailyRecords[date].signIn ? moment(dailyRecords[date].signIn).format('HH:mm:ss') : '-',
        'Sign Out': dailyRecords[date].signOut ? moment(dailyRecords[date].signOut).format('HH:mm:ss') : '-',
        'Notes/Comments': dailyRecords[date].notes || '-'
      }));

      return data.length ? data : [{
        Date: 'No records',
        User: userName,
        'Sign In': '-',
        'Sign Out': '-',
        'Notes/Comments': '-'
      }];
    }

    function exportToExcel() {
      const data = getTableData();
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Monthly Records');
      XLSX.writeFile(wb, 'monthly_sign_in_out.xlsx');
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Monthly Sign In/Out Records', 14, 16);
      doc.autoTable({
        head: [['Date', 'User', 'Sign In', 'Sign Out', 'Notes/Comments']],
        body: getTableData().map(row => [row.Date, row.User, row['Sign In'], row['Sign Out'], row['Notes/Comments']]),
        startY: 20,
        theme: 'grid',
        styles: { fontSize: 10 }
      });
      doc.save('monthly_sign_in_out.pdf');
    }

    function exportToWord() {
      const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType } = docx;
      const data = getTableData();
      const doc = new Document({
        sections: [{
          children: [
            new Paragraph({ text: 'Monthly Sign In/Out Records', heading: docx.HeadingLevel.HEADING_1 }),
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              rows: [
                new TableRow({
                  children: [
                    new TableCell({ children: [new Paragraph('Date')] }),
                    new TableCell({ children: [new Paragraph('User')] }),
                    new TableCell({ children: [new Paragraph('Sign In')] }),
                    new TableCell({ children: [new Paragraph('Sign Out')] }),
                    new TableCell({ children: [new Paragraph('Notes/Comments')] })
                  ]
                }),
                ...data.map(row => new TableRow({
                  children: [
                    new TableCell({ children: [new Paragraph(row.Date)] }),
                    new TableCell({ children: [new Paragraph(row.User)] }),
                    new TableCell({ children: [new Paragraph(row['Sign In'])] }),
                    new TableCell({ children: [new Paragraph(row['Sign Out'])] }),
                    new TableCell({ children: [new Paragraph(row['Notes/Comments'])] })
                  ]
                }))
              ]
            })
          ]
        }]
      });
      Packer.toBlob(doc).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'monthly_sign_in_out.docx';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateMonthlyLogTable();

      const signInArea = document.getElementById('signInArea');
      const signOutArea = document.getElementById('signOutArea');
      const exportButton = document.getElementById('exportButton');
      const exportMenu = document.getElementById('exportMenu');
      const undoButton = document.getElementById('undoButton');

      function handleClick(event, area, eventType) {
        const rect = area.getBoundingClientRect();
        const x = Math.round(event.clientX - rect.left);
        const y = Math.round(event.clientY - rect.top);
        const timestamp = new Date().toISOString();
        const accountData = JSON.parse(localStorage.getItem('accountDetails') || '{}');
        const userName = accountData.fullName || 'Guest';
        
        clickData.push({ x, y, timestamp, event: eventType, user: userName });
        localStorage.setItem('clickData', JSON.stringify(clickData));
        
        document.getElementById('lastClick').textContent = `${eventType} at ${moment(timestamp).format('YYYY-MM-DD HH:mm:ss')}`;
        document.getElementById('clickCoords').textContent = `(${x}, ${y})`;
        document.getElementById('totalClicks').textContent = clickData.length;
        updateMonthlyLogTable();
        showToast(`${eventType} recorded for ${moment(timestamp).format('YYYY-MM-DD')}`);
      }

      signInArea.addEventListener('click', (event) => handleClick(event, signInArea, 'Sign In'));
      signOutArea.addEventListener('click', (event) => handleClick(event, signOutArea, 'Sign Out'));

      exportButton.addEventListener('click', () => {
        exportMenu.classList.toggle('hidden');
      });

      document.addEventListener('click', (event) => {
        if (!exportButton.contains(event.target) && !exportMenu.contains(event.target)) {
          exportMenu.classList.add('hidden');
        }
      });

      undoButton.addEventListener('click', undoReset);

      const startOfWeek = moment().startOf('isoWeek');
      const labels = Array.from({ length: 6 }, (_, i) => startOfWeek.clone().add(i, 'days').format('ddd'));
      const data = labels.map(() => Math.floor(Math.random() * 25));

      const ctx = document.getElementById('dayGraph').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Hours Reported',
            data,
            backgroundColor: data.map(h => h >= 8 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(251, 191, 36, 0.7)'),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} hrs` } }
          },
          scales: {
            y: {
              min: 0,
              max: 24,
              title: { display: true, text: 'Hours' },
              ticks: {
                stepSize: 8,
                callback: val => `${val} hrs`
              }
            }
          }
        }
      });
    });
  </script>
</body>
</html>